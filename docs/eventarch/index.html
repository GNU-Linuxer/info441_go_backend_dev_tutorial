<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta http-equiv="X-UA-Compatible" content="ie=edge"><link rel="stylesheet" href="../lib/bulma.min.css"><link rel="stylesheet" href="../lib/font-awesome-4.7.0/css/font-awesome.min.css"><link rel="stylesheet" href="../lib/prism.css"><link rel="icon" href="../img/page-icon.png"><meta property="og:type" content="website"><meta property="og:site_name" content="INFO Tutorials"><meta property="og:title" content="Event-Driven Application Architecture"><meta property="og:description" content="How to code an application that renders state and handles user events"><meta property="og:image" content="https://drstearns.github.io/tutorials/img/page-icon.png"><title>Event-Driven Application Architecture</title><style>.is-funky{background-image:linear-gradient(to right,#006064,#880E4F)}.is-funky .subtitle,.is-funky .title{color:#fff}.screenshot{border:1px dotted #ccc;padding:10px;margin-bottom:1em}.bookmark-link{color:#ddd;margin-left:.25em}.home-link{color:#eee}.home-link:hover{color:#fff}.byline{font-size:.85rem;font-style:italic}.shaded{background-color:#eee}</style><script async src="https://www.googletagmanager.com/gtag/js?id=G-SQFSBJB996"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-SQFSBJB996")</script></head><body><header><div class="hero is-funky"><div class="hero-body"><div class="container"><div class="columns is-mobile"><div class="column"><h1 class="title">Event-Driven Application Architecture</h1><p class="subtitle">How to code an application that renders state and handles user events</p></div><div class="column is-narrow"><a href=".." class="home-link"><span class="icon is-medium"><i class="fa fa-home" aria-hidden="true" aria-label="back to table of contents"></i></span></a></div></div></div></div></div></header><main class="section"><div class="container"><div class="content"><p class="byline">Last edited on Oct 23, 2021 by <a href="https://www.linkedin.com/in/david-stearns-09a27319">Dave Stearns</a></p><p><a href="../html">HTML</a>, <a href="../css">CSS</a>, <a href="../javascript">JavaScript</a>, and <a href="../dom">the Document Object Model</a> give us everything we need to build just about any web application we could imagine. But if you sit down and try to build something complex like a browser-based game, you will quickly realize that you are still missing something important: how to structure a complex, interactive application so that it's easy to implement, reason about, and extend. That is to say, you need to learn how to <em>architect</em> interactive applications, and how to express that architecture in JavaScript.</p><h2 id="secstate">State</h2><p>At the core of any program are the data values that the program is tracking or manipulating, which we refer to as the program's <strong>state</strong>. This state is stored in the program's variables and function parameters. As the program executes, it reads this state to decide what to do, and sometimes modifies the state based on the results of some operation. At any moment, this state determines where the program is at and what it will do next.</p><p>For example, a simple game like <a href="https://en.wikipedia.org/wiki/Pong">single-player Pong</a> has only a few state values that it needs to track:</p><ul><li>the x/y position of the "ball"</li><li>the vector on which the ball is currently traveling (i.e., which direction its going)</li><li>the y position of the "paddle"</li></ul><p>Given these dynamic state values, as well as some hard-coded ones (e.g., radius of the ball), one could easily render the current game objects to the screen. If we change these values and update the screen on a regular basis (e.g., within a <code>for</code> loop), the game will appear to animate.</p><h2 id="seceventdrivenprogramming">Event-Driven Programming</h2><p>Many of the programs you wrote in your introductory computer science courses were non-interactive. These programs have an internal state, and they might initialize some of that state based on command-line arguments provided by the user, but once they start running they don't allow the user to modify that state via input interactions. All state modifications are done by the program's own internal logic, and the program generates some outputs before exiting.</p><p><img src="img/simple.png" alt="simple non-interactive architecture diagram"></p><p>Interactive applications, on the other hand, allow the user to modify the program's state while it's running via various input methods (keyboard, mouse, gesture, specialized controller, voice, etc.). These programs are typically written in an <strong>event-driven</strong> programming style, where the program has two distinct phases:</p><ul><li>The <strong>initialization phase</strong>, during which the program initializes its state and adds various event listener functions. These event listener functions will be invoked whenever the requested event occurs (e.g., mouse click, key press, page scroll, timer, etc.)</li><li>The <strong>event phase</strong>, during which the program waits for those events to occur. Each time an event occurs, the corresponding event listener function is invoked. That function in turn modifies the program's state, and updates the screen to match.</li></ul><p><img src="img/interactive.png" alt="event-driven interactive architecture diagram"></p><p>Event-driven programming is especially useful when your program needs to respond to multiple types of events. You can write your program in the style of "when this happens, execute this function." Your program can be structured so that each event listener function handles only one kind of event, modifying the program's state and updating the screen accordingly. The program's state remains the "single source of truth" for the program.</p><h2 id="secexample">Example</h2><p>Let's return to our single-player Pong example to see how this interactive architecture and event-driven style can be expressed in a browser-based JavaScript application.</p><h3 id="secstate-1">State</h3><p>In a browser-based JavaScript application, the program's state is commonly held in one global (or top-level scope) object that has one property for each state value you need to track. For example, at the start of our Pong game JavaScript, we could declare one global variable named <code>state</code>, and add various properties for our game objects:</p><pre class="language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">//constants</span>
<span class="token keyword">const</span> BALL_RADIUS <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> PADDLE_X <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> PADDLE_WIDTH <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> PADDLE_HEIGHT <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//application state</span>
<span class="token keyword">let</span> state <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//ball object</span>
    ball<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        x<span class="token punctuation">:</span> <span class="token comment" spellcheck="true">//...random x value...,</span>
        y<span class="token punctuation">:</span> <span class="token comment" spellcheck="true">//...random y value...,</span>
        vectorX<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        vectorY<span class="token punctuation">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">//paddle object</span>
    paddle<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        y<span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>Note that the <code>state</code> object tracks only the values that are likely to change while the application runs. Values that never change, such as the radius of the ball or the dimensions of the paddle, are better encoded as constants that we can refer to elsewhere in our code.</p><h3 id="secrendering">Rendering</h3><p>To make this state visible on screen, we need to create some HTML elements, and write a function that synchronizes those elements' attributes with the current application state values. The ball is best rendered as a circle, and the paddle as a rectangle, so <a href="https://developer.mozilla.org/en-US/docs/Web/SVG">SVG elements</a> would be a sensible choice. Alternatively, one could use an <a href="https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API/Tutorial">HTML <code>&lt;canvas&gt;</code> element</a> and re-draw the shapes using JavaScript after each state change.</p><p>The SVG elements would look something like this:</p><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    <span class="token comment" spellcheck="true">&lt;!-- SVG scene --></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>svg</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.w3.org/2000/svg<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token comment" spellcheck="true">&lt;!-- ball --></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>circle</span> <span class="token attr-name">cx</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span> <span class="token attr-name">cy</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span> <span class="token attr-name">r</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>5<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token comment" spellcheck="true">&lt;!-- paddle --></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rect</span> <span class="token attr-name">x</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>5<span class="token punctuation">"</span></span> <span class="token attr-name">y</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>5<span class="token punctuation">"</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>15<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>svg</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span></code></pre><p>To make that <code>&lt;svg&gt;</code> element cover the entire browser viewport, add some style rules like this:</p><pre class="language-css"><code class="language-css"><span class="token comment" spellcheck="true">/* remove any default margins/padding from the body */</span>
<span class="token selector">body</span> <span class="token punctuation">{</span>
    <span class="token property">margin</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
    <span class="token property">padding</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">/* make the svg element cover the entire viewport */</span>
<span class="token selector">svg</span> <span class="token punctuation">{</span>
    <span class="token property">width</span><span class="token punctuation">:</span> 100vw<span class="token punctuation">;</span>
    <span class="token property">height</span><span class="token punctuation">:</span> 100vh<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Finally, we define a function that accepts the current application state, and adjusts the attributes of those SVG elements to match:</p><pre class="language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">//select the elements once at startup</span>
<span class="token keyword">let</span> circle <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">"svg circle"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> rect <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">"svg rect"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//render will render the state to the page elements</span>
<span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//adjust element attriutes to match current state</span>
    circle<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">"cx"</span><span class="token punctuation">,</span> state<span class="token punctuation">.</span>ball<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    circle<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">"cy"</span><span class="token punctuation">,</span> state<span class="token punctuation">.</span>ball<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    rect<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">"y"</span><span class="token punctuation">,</span> state<span class="token punctuation">.</span>paddle<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Given this, we can now render our application state to the screen whenever it changes. To render the initial state, just add this to the end of your JavaScript:</p><pre class="language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">//render the initial state</span>
<span class="token function">render</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p><strong>Note:</strong> I added the SVG elements to the source HTML page to keep this example simple and easy-to-understand, but our program would be more flexible if the <code>render()</code> method <em>created</em> the necessary SVG elements if they were not already in the page. That way we could add new game objects to the state over time and they would automatically get added to the page the next time <code>render()</code> was called. But since SVG is a dialect of XML, creating SVG elements using JavaScript is a bit more cumbersome than creating normal HTML elements. To create new SVG elements, you must use the <code>document.createElementNS()</code> method in the DOM, and supply the string <code>"http://www.w3.org/2000/svg"</code> as the namespace argument.</p></blockquote><h3 id="seceventlisteners">Event Listeners</h3><p>After initializing and rendering the state, the program would next need add event listeners for at least two events:</p><ul><li>a timer event that occurs at a regular interval, which we will use to adjust the x/y position of the ball</li><li>the mouse move event, which we will use to adjust the y position of the paddle</li></ul><p>To add the timer, use the <code>setInterval()</code> function in the DOM. It takes a function to call and the number of milliseconds between each timer event:</p><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">animate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//adjust the ball's x/y coordinate</span>
    state<span class="token punctuation">.</span>ball<span class="token punctuation">.</span>x <span class="token operator">+</span><span class="token operator">=</span> state<span class="token punctuation">.</span>ball<span class="token punctuation">.</span>vectorX<span class="token punctuation">;</span>
    state<span class="token punctuation">.</span>ball<span class="token punctuation">.</span>y <span class="token operator">+</span><span class="token operator">=</span> state<span class="token punctuation">.</span>ball<span class="token punctuation">.</span>vectorY<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//if the ball has hit the top or bottom of the browser window</span>
    <span class="token comment" spellcheck="true">//negate vectorY so that it bounces back</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>ball<span class="token punctuation">.</span>y <span class="token operator">-</span> BALL_RADIUS <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">||</span>
        state<span class="token punctuation">.</span>ball<span class="token punctuation">.</span>y <span class="token operator">+</span> BALL_RADIUS <span class="token operator">>=</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        state<span class="token punctuation">.</span>ball<span class="token punctuation">.</span>vectorY <span class="token operator">*</span><span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//if the ball has hit the right edge of the browser window</span>
    <span class="token comment" spellcheck="true">//negate vectorX so that it bounces back</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>ball<span class="token punctuation">.</span>x <span class="token operator">+</span> BALL_RADIUS <span class="token operator">>=</span> window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        state<span class="token punctuation">.</span>ball<span class="token punctuation">.</span>vectorX <span class="token operator">*</span><span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//if the ball has hit the paddle, negate vectorX so that</span>
    <span class="token comment" spellcheck="true">//the ball bounces back</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>ball<span class="token punctuation">.</span>x <span class="token operator">-</span> BALL_RADIUS <span class="token operator">&lt;=</span> PADDLE_X <span class="token operator">+</span> PADDLE_WIDTH <span class="token operator">&amp;&amp;</span> 
        state<span class="token punctuation">.</span>ball<span class="token punctuation">.</span>y <span class="token operator">>=</span> state<span class="token punctuation">.</span>paddle<span class="token punctuation">.</span>y <span class="token operator">&amp;&amp;</span> 
        state<span class="token punctuation">.</span>ball<span class="token punctuation">.</span>y <span class="token operator">&lt;=</span> state<span class="token punctuation">.</span>paddle<span class="token punctuation">.</span>y <span class="token operator">+</span> PADDLE_HEIGHT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        state<span class="token punctuation">.</span>ball<span class="token punctuation">.</span>vectorX <span class="token operator">*</span><span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//render the adjusted state</span>
    <span class="token function">render</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//call animate() every 16 milliseconds</span>
state<span class="token punctuation">.</span>ballTimer <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span>animate<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>The <code>setInterval()</code> function returns a timer object that you can use to <a href="https://www.w3schools.com/jsref/met_win_clearinterval.asp">stop the timer</a> when the game ends. You can store this in a separate variable, or you can simply add it to your game state as a new property.</p><blockquote><p><strong>NOTE:</strong> most browsers now support a more efficient mechanism for this animation timer. Instead of calling <code>setInterval()</code> call <code>requestAnimationFrame()</code> instead. For more details, see <a href="https://developer.mozilla.org/en-US/docs/Web/API/window/requestAnimationFrame">the documentation for this function</a>. Note that <code>requestAnimationFrame()</code> calls your listener function only once, so you must call <code>requestAnimationFrame()</code> again at the end of your listener function if you want to continue animating.</p></blockquote><p>To listen for the mouse move event, use the <code>addEventListener()</code> method on the element the mouse will move over. In this case we can simply using the <code>&lt;body&gt;</code> element, as our "court" will take up the entire page.</p><pre class="language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">//eventObj is provided by the DOM and it contains info about the event</span>
<span class="token comment" spellcheck="true">//see https://developer.mozilla.org/en-US/docs/Web/Events/mousemove</span>
<span class="token keyword">function</span> <span class="token function">adjustPaddle</span><span class="token punctuation">(</span>eventObj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//adjust the paddle's y coordinate so that</span>
    <span class="token comment" spellcheck="true">//the middle of the paddle is at the same spot</span>
    <span class="token comment" spellcheck="true">//as the mouse pointer</span>
    state<span class="token punctuation">.</span>paddle<span class="token punctuation">.</span>y <span class="token operator">=</span> eventObj<span class="token punctuation">.</span>clientY <span class="token operator">-</span> <span class="token punctuation">(</span>PADDLE_HEIGHT <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//render the adjusted state</span>
    <span class="token function">render</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"mousemove"</span><span class="token punctuation">,</span> adjustPaddle<span class="token punctuation">)</span></code></pre><p>These two event listeners are all you need. The first updates the state of the ball, and the second updates the state of the paddle. The first will be called on a regular basis to animate the ball, and the second will be called whenever the user moves the mouse.</p><p>The only thing left to add is the logic that checks whether the ball has gone behind the paddle. When that occurs, the game should end. Try adding that to create a complete Pong game!</p></div></div></main><footer class="footer"><div class="container"><div class="content"><p>Created by <a href="https://www.linkedin.com/in/david-stearns-09a27319">Dave Stearns</a>, <a href="https://ischool.uw.edu">The Information School</a>, <a href="https://uw.edu">University of Washington</a></p><p><a href=".."><span class="icon"><i class="fa fa-home"></i> </span>back to contents</a></p></div></div></footer><script>var headings=document.querySelectorAll("h2,h3,h4,h5");headings.forEach(function(e){var a=document.createElement("a");a.textContent="#",a.href="#"+e.id,a.classList.add("bookmark-link"),e.appendChild(a)})</script></body></html>