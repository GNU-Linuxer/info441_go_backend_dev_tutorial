<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta http-equiv="X-UA-Compatible" content="ie=edge"><link rel="stylesheet" href="../lib/bulma.min.css"><link rel="stylesheet" href="../lib/font-awesome-4.7.0/css/font-awesome.min.css"><link rel="stylesheet" href="../lib/prism.css"><link rel="icon" href="../img/page-icon.png"><meta property="og:type" content="website"><meta property="og:site_name" content="INFO Tutorials"><meta property="og:title" content="Talking to Databases from Go"><meta property="og:description" content="Interacting with persistent relational and document-oriented DBMSs"><meta property="og:image" content="https://drstearns.github.io/tutorials/img/page-icon.png"><title>Talking to Databases from Go</title><style>.is-funky{background-image:linear-gradient(to right,#006064,#880E4F)}.is-funky .subtitle,.is-funky .title{color:#fff}.screenshot{border:1px dotted #ccc;padding:10px}.bookmark-link{color:#ddd;margin-left:.25em}.home-link{color:#eee}.home-link:hover{color:#fff}.byline{font-size:.85rem;font-style:italic}</style></head><body><header><div class="hero is-funky"><div class="hero-body"><div class="container"><div class="columns is-mobile"><div class="column"><h1 class="title">Talking to Databases from Go</h1><p class="subtitle">Interacting with persistent relational and document-oriented DBMSs</p></div><div class="column is-narrow"><a href=".." class="home-link"><span class="icon is-medium"><i class="fa fa-home" aria-hidden="true" aria-label="back to table of contents"></i></span></a></div></div></div></div></div></header><main class="section"><div class="container"><div class="content"><p class="byline">Last edited on Aug 6, 2017 by <a href="https://ischool.uw.edu/people/faculty/dlsinfo">Dave Stearns</a></p><p>Web-based information systems need to store and manage large amounts of data, so they typically enlist the help of a persistent database management system (DBMS). These are separate server processes that encapsulate and manage the actual data and index files on disk, while supporting simultaneous access by multiple clients.</p><p>This tutorial assumes you've already taken <a href="https://www.washington.edu/students/crscat/info.html#info340">a relational DBMS course</a> and already know the basics of the Structure Query Language (SQL). I will show you how to interact with a relational DBMS from Go, and how to avoid SQL injection attacks.</p><p>I will also show you how to interact with the popular document-oriented DBMS MongoDB. As opposed to a relational database that stores data in flat tables with columns, MongoDB stores full JSON documents that can have arbitrary schema, nested objects, arrays, etc. This flexibility is handy for many types of information systems, but it does come with a few trade-offs that I will discuss in more detail below.</p><h2 id="secinteractingwithrelationaldbmss">Interacting with Relational DBMSs</h2><p>In order to interact with a relational database from Go, we need a relational DBMS instance we can connect to and play with. Since you now know how to use <a href="../docker/">Docker</a>, we can use it to spin-up any of the popular open-source relational DBMSs: MySQL/MariaDB, PostgreSQL, etc. There are endless debates about which of these is the best choice, and in truth, the answer depends on what you need the DBMS to do and how willing you are to tune it.</p><p>For purposes of this tutorial, let's use MySQL, though the code will be nearly identical if you choose a different DBMS. The only real differences will be which package you import, and what dialect of SQL you use for your queries.</p><h3 id="secrunningthemysqldockercontainer">Running the MySQL Docker Container</h3><p>Like many relational DBMSs, MySQL implements its own security system, with its own user accounts and passwords that are distinct from the host operating system. New instances automatically have one super-user account, known as <code>root</code>, but you need to supply the password you want that account to have. The easiest way to do that is to create an environment variable to store that. In a terminal window, define a new environment variable for the root account password:</p><pre class="language-bash"><code class="language-bash"><span class="token function">export</span> MYSQL_ROOT_PASSWORD<span class="token operator">=</span><span class="token string">"some super-secret password"</span></code></pre><p>If you just want a randomly-generated password, you can use the <code>rand</code> subcommand of <code>openssl</code>:</p><pre class="language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># generate 18 random bytes and base64 encode them</span>
<span class="token function">export</span> MYSQL_ROOT_PASSWORD<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>openssl rand -base64 18<span class="token variable">)</span></span>
<span class="token comment" spellcheck="true"># echo it so that you can see what it generated</span>
<span class="token keyword">echo</span> <span class="token variable">$MYSQL_ROOT_PASSWORD</span></code></pre><p>This sets the environment variable in the host shell, but remember that Docker containers are completely isolated by default, so we need to forward this environment variable into the container when we run it. We also want to publish the default MySQL port number (3306) so that we can connect to MySQL server from our Go program running on the host. In production, we would use a Docker private network and run both our Go server and the MySQL server containers in that private network, but for now we will connect directly from a host process.</p><p>To start the MySQL server with these settings, use this command</p><pre class="language-bash"><code class="language-bash">docker run -d \
-p 3306:3306 \
--name testmysql \
-e MYSQL_ROOT_PASSWORD<span class="token operator">=</span><span class="token variable">$MYSQL_ROOT_PASSWORD</span> \
mysql</code></pre><p>Use <code>docker ps</code> to make sure the server is running. If it's not listed, use <code>docker logs testmysql</code> to see what error it wrote to the log file.</p><p>If you want to connect to this running MySQL instance using the MySQL CLI, you can run another container instance, overriding the default entry point:</p><pre class="language-bash"><code class="language-bash">docker run -it \
--rm \
--network host \
-e MYSQL_ROOT_PASSWORD<span class="token operator">=</span><span class="token variable">$MYSQL_ROOT_PASSWORD</span> \
mysql sh -c <span class="token string">'mysql -h127.0.0.1 -uroot -p<span class="token variable">$MYSQL_ROOT_PASSWORD</span>'</span></code></pre><p>Try executing <code>show databases;</code> to see the default list of databases. Execute the <code>exit</code> command to exit the CLI and return to your host prompt. Since we used the <code>--rm</code> flag, this CLI container will automatically be removed after it exits.</p><h3 id="secinstallingthemysqlclientpackage">Installing the MySQL Client Package</h3><p>The Go standard library defines a common set of functions and structs in the <a href="https://golang.org/pkg/database/sql/">database/sql</a> package that are used for all relational DBMSs. This code in turn uses a RDBMS-specific package, known as a <strong>driver</strong>, to actually communicate with the database. These drivers implement the interfaces defined in the <a href="https://golang.org/pkg/database/sql/driver/">database/sql/driver</a> package for the specific RDBMS protocol.</p><p>To install the <a href="https://github.com/go-sql-driver/mysql">MySQL diver for Go</a> on your system, use this command:</p><pre class="language-bash"><code class="language-bash">go get github.com/go-sql-driver/mysql</code></pre><p>If it worked, you won't see any output: no news is good news!</p><h3 id="secconnectingfromagoprogram">Connecting From a Go Program</h3><p>Create a new directory within your <code>$GOPATH/src</code> directory, and in that directory create a new file named <code>main.go</code>. Add this code to that file:</p><pre class="language-go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"database/sql"</span>
    <span class="token string">"fmt"</span>
    <span class="token string">"os"</span>

    <span class="token boolean">_</span> <span class="token string">"github.com/go-sql-driver/mysql"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//create the data source name, which identifies the</span>
    <span class="token comment" spellcheck="true">//user, password, server address (defaults to 127.0.0.1)</span>
    <span class="token comment" spellcheck="true">//and the default database (defaults to none)</span>
    dsn <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"root:%s@/"</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span><span class="token function">Getenv</span><span class="token punctuation">(</span><span class="token string">"MYSQL_ROOT_PASSWORD"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">//create a database object, which manages a pool of</span>
    <span class="token comment" spellcheck="true">//network connections to the database server</span>
    db<span class="token punctuation">,</span> err <span class="token operator">:=</span> sql<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">"mysql"</span><span class="token punctuation">,</span> dsn<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"error opening database: %v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//for now, just ping the server to ensure we have</span>
    <span class="token comment" spellcheck="true">//a live connection to it</span>
    <span class="token keyword">if</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Ping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"error pinging database: %v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"successfully connected!\n"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>The <code>_ "github.com/go-sql-driver/mysql"</code> import line might look strange, but it is essentially importing the MySQL driver without creating a local name for the package in our code. Since we will always be using the common functions and structs in the <code>database/sql</code> package, we will never need to call the MySQL driver directly. As you might have noticed before, Go requires that you actually use all variables you declare, and package names are just like variables, so if you import a package but never use anything from it, the Go compiler will generate an error, and the <code>goimports</code> tool will simply remove the import. But if we don't import the package, its code won't be in our built executable. To import a package that you never call, you can assign the blank identifier (<code>_</code>) to the imported package.</p></div></div></main><footer class="footer"><div class="container"><div class="content"><p>Created by <a href="https://ischool.uw.edu/people/faculty/dlsinfo">Dave Stearns</a>, <a href="https://ischool.uw.edu">The Information School</a>, <a href="https://uw.edu">University of Washington</a></p><p><a href=".."><span class="icon"><i class="fa fa-home"></i> </span>back to contents</a></p></div></div></footer><script>var headings=document.querySelectorAll("h2,h3,h4,h5");headings.forEach(function(e){var a=document.createElement("a");a.textContent="#",a.href="#"+e.id,a.classList.add("bookmark-link"),e.appendChild(a)})</script><script>!function(e,t,a,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=t.createElement(a),s=t.getElementsByTagName(a)[0],o.async=1,o.src="https://www.google-analytics.com/analytics.js",s.parentNode.insertBefore(o,s)}(window,document,"script",0,"ga"),ga("create","UA-102177301-1","auto"),ga("send","pageview")</script></body></html>