<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta http-equiv="X-UA-Compatible" content="ie=edge"><link rel="stylesheet" href="../lib/bulma.min.css"><link rel="stylesheet" href="../lib/font-awesome-4.7.0/css/font-awesome.min.css"><link rel="stylesheet" href="../lib/prism.css"><link rel="icon" href="../img/page-icon.png"><meta property="og:type" content="website"><meta property="og:site_name" content="INFO Tutorials"><meta property="og:title" content="Deploying to Digital Ocean"><meta property="og:description" content="How to create droplets and run your Docker containers"><meta property="og:image" content="https://drstearns.github.io/tutorials/img/page-icon.png"><title>Deploying to Digital Ocean</title><style>.is-funky{background-image:linear-gradient(to right,#006064,#880E4F)}.is-funky .subtitle,.is-funky .title{color:#fff}.screenshot{border:1px dotted #ccc;padding:10px;margin-bottom:1em}.bookmark-link{color:#ddd;margin-left:.25em}.home-link{color:#eee}.home-link:hover{color:#fff}.byline{font-size:.85rem;font-style:italic}.shaded{background-color:#eee}</style><script async src="https://www.googletagmanager.com/gtag/js?id=G-SQFSBJB996"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-SQFSBJB996")</script></head><body><header><div class="hero is-funky"><div class="hero-body"><div class="container"><div class="columns is-mobile"><div class="column"><h1 class="title">Deploying to Digital Ocean</h1><p class="subtitle">How to create droplets and run your Docker containers</p></div><div class="column is-narrow"><a href=".." class="home-link"><span class="icon is-medium"><i class="fa fa-home" aria-hidden="true" aria-label="back to table of contents"></i></span></a></div></div></div></div></div></header><main class="section"><div class="container"><div class="content"><p class="byline">Last edited on Oct 23, 2021 by <a href="https://ischool.uw.edu/people/faculty/dlsinfo">Dave Stearns</a></p><p>Now that you know how to <a href="../docker/">build your own Docker containers</a>, it's now time to learn how you can deploy those to a VM running in the cloud. This tutorial describes how to deploy to DigitalOcean, which is a cloud hosting service that offers reasonable pricing, a clean and easy-to-use UI, superb tutorials, and a powerful API.</p><p>DigitalOcean offers only a few core services, so it's much simpler than Amazon Web Services (AWS). Their primary service is virtual machines, which they call "droplets" (a droplet in the vast digital ocean...get it?). They also offer load balancers and general blob storage, but that's about it. Although they have a limited number of services, those services are relatively cheap: their entry-level droplets are only $5/month.</p><p>If you don't already have a DigitalOcean account, <a href="https://cloud.digitalocean.com/registrations/new">sign-up for one</a> before proceeding. If you are taking INFO 344, contact your TA for a promo code that you can use to get enough credit to cover the costs related to the assignments.</p><h2 id="secgeneratingandregisteringsshkeys">Generating and Registering SSH Keys</h2><p>When you create a VM in any cloud infrastructure, you need a way to connect to it via <code>ssh</code> as a user with administrator privileges so that you can perform administrative tasks. SSH stands for "secure shell," and to be secure, it needs to authenticate you and encrypt communications between your development machine and the server. SSH can do that in one of two ways: you can supply the root user's password (not recommended); or you create and setup SSH keys (recommended).</p><p>SSH keys are private/public key pairs, similar to the ones used in <a href="../https/">TLS</a>. You can generate this key pair on your development machine, and add the public key to any new droplet you create. When you connect, the <code>ssh</code> command uses your private key (which remains on your development machine only) to encrypt a message, and the droplet uses your public key to verify that message. Since you should be the only person in possession of your private key, it knows that you are you, and the authentication succeeds.</p><h3 id="secgenerateakeypair">Generate a Key Pair</h3><p>To see if you already have an SSH key pair generated, use this command:</p><pre class="language-bash"><code class="language-bash"><span class="token function">ls</span> ~/.ssh</code></pre><p>If you see files named <code>id_rsa</code> and <code>id_rsa.pub</code>, you already have a key pair and you can skip to the next section.</p><p>If you get a "no such file or directory" error, or if you don't see any files listed, you don't have a key pair generated yet. Use this command to generate one:</p><pre class="language-bash"><code class="language-bash">ssh-keygen -t rsa</code></pre><p>You will be prompted as to whether you want to add a passphrase to the private key. This is an added security measure you may want to use, but beware that you'll have to type this passphrase every time you use the key. Enter the passphrase, or just hit return to use no passphrase.</p><p>You'll see some output telling you where the new "identification" (private key) and public key files were saved. Now we need to register the public key with our DigitalOcean account.</p><h3 id="secregisteryourpublickey">Register your Public Key</h3><p>After signing up for an account (or signing in to an existing one), click on your Avatar in the top right corner and choose "Settings" from the drop-down menu. Then click on the "Security" link in the left-side navigation area. Or you can <a href="https://cloud.digitalocean.com/settings/security">jump to this screen directly</a>.</p><p>Under the "SSH keys" section, choose the "Add SSH Key" button. You'll see a dialog that looks like this:</p><p><img class="screenshot" src="img/ssh-key.png" alt="add ssh key dialog"></p><p>You need to copy the contents of your <strong>public key</strong> (not your private key) into the first box. By default, the public key is stored in the file <code>~/.ssh/id_rsa.pub</code>. You can open that in your favorite text editor, or you can just dump it to your terminal using this command:</p><pre class="language-bash"><code class="language-bash"><span class="token function">cat</span> ~/.ssh/id_rsa.pub</code></pre><p>Copy the contents of that file to your clipboard and paste it into the large box labeled "SSH key content." If you're on a Mac, you can copy it to the clipboard from the terminal using this command</p><pre class="language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># MacOS only</span>
<span class="token function">cat</span> ~/.ssh/id_rsa.pub <span class="token operator">|</span> pbcopy</code></pre><p>On Windows, pipe the output to the <code>clip</code> command instead:</p><pre class="language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># Windows only</span>
<span class="token function">cat</span> ~/.ssh/id_rsa.pub <span class="token operator">|</span> clip</code></pre><p>On Linux you can install and pipe the output to the <code>xclip</code> command:</p><pre class="language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># Linux only</span>
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> -y xclip
<span class="token function">cat</span> ~/.ssh/id_rsa.pub <span class="token operator">|</span> xclip -selection c</code></pre><p>After you paste the contents of the file, enter a name in the second box that describes the computer you are currently using (e.g., "Laptop" or "Home PC"). Since the private key will remain on this computer only, you should use something that identifies this particular computer.</p><p>You can add multiple SSH keys to your account, one for each computer you use. When you create a droplet, you can add all of the registered public keys to the new droplet, so that you can connect to it from any of your computers.</p><h2 id="seccreatingadroplet">Creating a Droplet</h2><p>Return to <a href="https://cloud.digitalocean.com/droplets">your Droplets list</a>, which will be empty. Click on the big blue button labeled "Create Droplet":</p><p><img src="img/no-droplets.png" alt="droplet list showing create droplet button" class="screenshot"></p><p>DigitalOcean has several pre-built images you can use for these droplets, including all the commonly-used Linux distros. But if you want to run a <a href="../docker/">Docker container</a>, there's a special "One-Click app" that already has Docker pre-installed on an Ubuntu Long-Term Support (LTS) distro. The specific version numbers vary over time, but it will be called something like "Docker x.x.x-ce on x.x." In the screen shot below, it's highlighted in red:</p><p><img src="img/one-click-apps.png" alt="one-click apps list highlighting Docker on Ubuntu" class="screenshot"></p><p>You can of course choose any base Linux distro and install Docker yourself, but this one-click app a convenient way to get up-and-running quickly.</p><p>After selecting the image, the next section of the page lets you choose the size of your VM. It will default to selecting the $20/month VM, so <strong>make sure you select the cheapest one instead for this tutorial</strong>.</p><p>You don't need any additional block storage, so you can skip the next section. The following section lets you choose which data center you want your VM to run in. You should choose a data center that is geographically close to your target users and/or yourself. Although the Web often feels instantaneous, geography still matters: a few hundred milliseconds of extra latency can become noticeable if your application makes a lot of requests.</p><p>You can also skip the Additional Options section for now. This allows you to add various options like IPv6 support, automated backups, monitoring, and private networking.</p><p>The following section allows you to select the SSH Key you registered in the previous section. Choose the SSH key(s) you registered, or you can register a new one if you skipped that previous section. Adding SSH keys to your droplet is a very good idea: your new droplet will be accessible only to you, as only you have the associated private key. If you don't add an SSH key, DigitalOcean will generate a random root user password and send it to you via email. Because email is not a terribly secure medium, it's best to use SSH keys instead.</p><p>In the final section you can adjust the number of droplets you are creating (leave at 1 for now) and override the host name that DigitalOcean generated for you (you can leave it as is for now). Click the big "Create" button to create your droplet.</p><h2 id="secconnectingtoyourdroplet">Connecting to Your Droplet</h2><p>You should see your new droplet in your droplets list, and once it says that the droplet is ready, copy the droplet's IP address to your clipboard. Then in a terminal window use this command to connect to it, replacing <code>ip-address</code> with your droplet's IP address:</p><pre class="language-bash"><code class="language-bash"><span class="token function">ssh</span> root@ip-address</code></pre><p>You may see a message that the host is not yet in your known hosts list, and you can enter <code>yes</code> to add it to that list. You should then see a new prompt, which is a new bash shell running on your new droplet. You can now type commands as if you were directly connected to that droplet. Everything you type will be sent to the server and executed there.</p><blockquote><p><strong>NOTE:</strong> if the ssh connection times out, give it a minute and try again. Sometimes it takes a minute for the ssh server on a brand-new droplet to be ready for new connections.</p></blockquote><h2 id="secverifyingthefirewall">Verifying the Firewall</h2><p>The firewall should be enabled by default, but to verify, enter this command:</p><pre class="language-bash"><code class="language-bash">ufw status</code></pre><p>The <code>ufw</code> command is short for "uncomplicated firewall," and the <code>status</code> subcommand displays the firewall's current status. If it reports a status of "active" you are good to go. If it reports that the firewall is not enabled, you can enable it using these commands:</p><pre class="language-bash"><code class="language-bash">ufw allow OpenSSH
ufw <span class="token function">enable</span></code></pre><p>Use <code>ufw status</code> one more time to ensure that the firewall is now active.</p><h2 id="secrunningyourdockercontainers">Running Your Docker Containers</h2><p>Docker should already be pre-installed, so to run any Docker container, simply use the <code>docker run</code> command that was discussed in the <a href="../docker/">Docker tutorial</a>. For example, to run your example web site container image you built during that tutorial, use this command, replacing "your-dockerhub-name" with your Docker Hub name:</p><pre class="language-bash"><code class="language-bash">docker run -d -p 80:80 --name exsite your-dockerhub-name/examplewebsite</code></pre><p>Docker will automatically open any published ports on the firewall, so your website should now be live on the Web. You can test it by requesting the URL <code>http://ip-address</code> where <code>ip-address</code> is the IP address of your droplet.</p><h2 id="secexecutingscriptsonyourdroplet">Executing Scripts on Your Droplet</h2><p>Running a single Docker container is easily done using the steps above, but when you need to run multiple containers, providing lots of command-line flags, it's better practice to put those <code>docker run</code> commands into a bash script that can you run on your droplet. This script can also include the necessary <code>docker pull</code> and <code>docker rm -f</code> commands to upgrade and run new versions of your containers.</p><p>You can keep this bash script in your source code repository, yet run it on your droplet using <code>ssh</code>. For example, say you had a script named <code>upgrade-server.sh</code> that looks something like this:</p><pre class="language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># pull most current version of example web site container image</span>
docker pull your-dockerhub-name/examplewebsite

<span class="token comment" spellcheck="true"># stop and remove current container instance</span>
docker <span class="token function">rm</span> -f exsite 

<span class="token comment" spellcheck="true"># run instance of newly-updated container image</span>
docker run -d -p 80:80 --name exsite your-dockerhub-name/examplewebsite</code></pre><p>These commands need to be executed on the server, not on our local dev machine. We could copy this script file to the server, <code>ssh</code> into the server, and then execute the script. Or we could just ask <code>ssh</code> to run this script on the server in one operation:</p><pre class="language-bash"><code class="language-bash"><span class="token function">ssh</span> root@<span class="token variable">$ip</span>-address <span class="token string">'bash -s'</span> <span class="token operator">&lt;</span> upgrade-server.sh</code></pre><p>The first part of this <code>ssh</code> command will look familiar, but what follows the user name and network address is a command you want to run on the server once <code>ssh</code> is connected. That command is <code>bash -s</code>, which runs an instance of the bash shell, telling it to execute the script it receives from standard input. The <code>&lt; upgrade-server.sh</code> part redirects standard input to read the contents of the <code>upgrade-server.sh</code> file, so <code>bash</code> will execute everything in that file on the server.</p><p>When executing <code>ssh</code> this way, you don't get an interactive terminal on the server. Instead it connects to your server, executes the script, and disconnects, returning you to the command prompt on your local machine.</p><p>To do a full deployment, you can write another script called <code>deploy.sh</code> that combines the <code>ssh</code> command above with a <code>docker push</code>:</p><pre class="language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># push the most recently-built container image to Docker Hub</span>
docker push your-dockerhub-name/examplewebsite

<span class="token comment" spellcheck="true"># execute the upgrade-server.sh script on our server</span>
<span class="token comment" spellcheck="true"># the -oStrictHostKeyChecking=no skips the prompt</span>
<span class="token comment" spellcheck="true"># about adding the host to the list of known hosts</span>
<span class="token comment" spellcheck="true"># so that this script doesn't get interrupted if the</span>
<span class="token comment" spellcheck="true"># server's IP/hostname is new to us</span>
<span class="token function">ssh</span> -oStrictHostKeyChecking<span class="token operator">=</span>no root@<span class="token variable">$ip</span>-address <span class="token string">'bash -s'</span> <span class="token operator">&lt;</span> upgrade-server.sh</code></pre><blockquote><p><strong>Windows Users:</strong> keep in mind that Windows and Unix-based systems (such as Linux) use different byte sequences for line endings in text files, so any Bash script you run on a Linux server via <code>ssh</code> <strong>must be saved using Unix-style line endings</strong>. On Windows each line in a text file typically ends with the byte sequence <code>0x0D 0x0A</code>, which is Carriage Return (CR) followed by Line Feed (LF), often expressed in code as <code>\r\n</code>. On Unix each line ends with just <code>0x0A</code> (LF or <code>\n</code>). If you try to execute a bash script that has Windows-style line endings on a Linux server via <code>ssh</code>, the Bash shell on the Linux side won't interpret the line endings correctly, and will generate all kinds of really strange errors.</p><p>Thankfully, all code editors will let you override the default line endings used for a given file, so you can tell your editor to use only LF for bash scripts you intend to run on your Linux server. In Visual Studio Code, click on the <code>CRLF</code> text in the blue status bar at the bottom of the window, choose <code>LF</code> from the popup list shown at the top of the window, and save the file to convert the line endings. Editors should recognize the line endings used for a given file when you load it, and preserve those line endings when re-saving.</p><p>Note that this applies only to scripts that you want to execute <em>on a Linux server</em>. Any Bash script you intend to execute locally on your Windows development machine can have Windows-style line endings.</p></blockquote><h2 id="secassociatingadomainname">Associating a Domain Name</h2><p>If you want to associate a domain name you've purchased with your DigitalOcean droplet refer to their excellent <a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-a-host-name-with-digitalocean">How to Set Up a Host Name with DigitalOcean</a> tutorial. The Domain Name Server fields on your domain registrar may be somewhat difficult to find, but every registrar should let you set those.</p><h2 id="secscriptitwiththedigitaloceancli">Script It with the DigitalOcean CLI</h2><p>The DigitalOcean UI is actually just a simple web client that uses their <a href="https://developers.digitalocean.com/documentation/v2/">public API</a> to do all of the work. You can use that API from your own programs, but there's also a handy CLI you can use from bash scripts. This CLI is called <a href="https://www.digitalocean.com/community/tutorials/how-to-use-doctl-the-official-digitalocean-command-line-client">doctl</a>, and it's written in Go!</p><p>If you have Go installed, use <code>go get</code> to download and install <code>doctl</code>:</p><pre class="language-bash"><code class="language-bash">go get github.com/digitalocean/doctl/cmd/doctl</code></pre><p>To verify the installation, run <code>doctl version</code>. If you get a version number, all is OK. If you get a command not found error, something went wrong. Ensure you have Go intalled and that you <a href="../gointro/#secconfiguringgo">setup your Go Workspace</a> correctly.</p><p>The <code>doctl</code> CLI uses the public API, so you must first <a href="https://www.digitalocean.com/community/tutorials/how-to-use-the-digitalocean-api-v2#how-to-generate-a-personal-access-token">generate an access token</a> for your account, and then register that token with the tool using this command:</p><pre class="language-bash"><code class="language-bash">doctl auth init</code></pre><p>You can now use doctl to do anything you could have done through DigitalOcean's User Interface. For example, to list your current droplets, use this command:</p><pre class="language-bash"><code class="language-bash">doctl compute droplet list</code></pre><p>To list your registered SSH keys, you can use this command:</p><pre class="language-bash"><code class="language-bash">doctl compute ssh-key list</code></pre><p>To create a new droplet from the Docker on Ubuntu image, you can use a command like this:</p><pre class="language-bash"><code class="language-bash">doctl compute droplet create my-droplet-name \
--image docker-16-04 \
--region sfo2 \
--size s-1vcpu-1gb \
--ssh-keys <span class="token punctuation">..</span>. <span class="token function">ssh</span> key fingerprint from: doctl compute ssh-key list <span class="token punctuation">..</span>. \
--wait</code></pre><p>The best documentation for this CLI is actually in the tool itself. Use <code>doctl help</code> to list all of the available subcommands, and if you want help with any particular subcommand, add the subcommand name after <code>doctl help</code> (for example, <code>doctl help compute</code>). You can keep going to see options for final commands: for example <code>doctl help compute droplet create</code>.</p><p>Using this tool, you can easily write bash scripts to create droplets and manage domains.</p><h2 id="secdeclareitusingterraform">Declare it Using Terraform</h2><p>Another popular option for automating the creation of VMs is <a href="https://www.terraform.io/">Hashicorp's Terraform</a>. This tool allows you to declare what sort of cloud resources you want, and it handles detecting which already exist and which need to be created. It also works with multiple cloud providers (DigitalOcean, AWS, Google Cloud, etc). See their <a href="https://www.terraform.io/intro/index.html">Getting Started Guide</a> to learn more.</p></div></div></main><footer class="footer"><div class="container"><div class="content"><p>Created by <a href="https://ischool.uw.edu/people/faculty/dlsinfo">Dave Stearns</a>, <a href="https://ischool.uw.edu">The Information School</a>, <a href="https://uw.edu">University of Washington</a></p><p><a href=".."><span class="icon"><i class="fa fa-home"></i> </span>back to contents</a></p></div></div></footer><script>var headings=document.querySelectorAll("h2,h3,h4,h5");headings.forEach(function(e){var a=document.createElement("a");a.textContent="#",a.href="#"+e.id,a.classList.add("bookmark-link"),e.appendChild(a)})</script></body></html>