<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta http-equiv="X-UA-Compatible" content="ie=edge"><link rel="stylesheet" href="../lib/bulma.min.css"><link rel="stylesheet" href="../lib/font-awesome-4.7.0/css/font-awesome.min.css"><link rel="stylesheet" href="../lib/prism.css"><link rel="icon" href="../img/page-icon.png"><meta property="og:type" content="website"><meta property="og:site_name" content="INFO Tutorials"><meta property="og:title" content="Deploying to Digital Ocean"><meta property="og:description" content="How to create droplets and run your Docker containers"><meta property="og:image" content="https://drstearns.github.io/tutorials/img/page-icon.png"><title>Deploying to Digital Ocean</title><style>.is-funky{background-image:linear-gradient(to right,#006064,#880E4F)}.is-funky .subtitle,.is-funky .title{color:#fff}.screenshot{border:1px dotted #ccc;padding:10px}.bookmark-link{color:#ddd;margin-left:.25em}.home-link{color:#eee}.home-link:hover{color:#fff}.byline{font-size:.85rem;font-style:italic}</style></head><body><header><div class="hero is-funky"><div class="hero-body"><div class="container"><div class="columns is-mobile"><div class="column"><h1 class="title">Deploying to Digital Ocean</h1><p class="subtitle">How to create droplets and run your Docker containers</p></div><div class="column is-narrow"><a href=".." class="home-link"><span class="icon is-medium"><i class="fa fa-home" aria-hidden="true" aria-label="back to table of contents"></i></span></a></div></div></div></div></div></header><main class="section"><div class="container"><div class="content"><p class="byline">Last edited on Aug 6, 2017 by <a href="https://ischool.uw.edu/people/faculty/dlsinfo">Dave Stearns</a></p><p>Now that you know how to <a href="../docker/">build your own Docker containers</a>, it's now time to learn how you can deploy those to a VM running in the cloud. This tutorial describes how to deploy to DigitalOcean, which is a cloud hosting service that offers reasonable pricing, a clean and easy-to-use UI, superb tutorials, and a powerful API.</p><p>DigitalOcean offers only a few core services, so it's much simpler than Amazon Web Services (AWS). Their core service is virtual machines, which they call "droplets" (a droplet in the vast digital ocean...get it?). They also offer load balancers and general file storage, but that's about it. Although they have a limited number of services, those services are relatively cheap: their entry-level droplets, which have 512MB of RAM and 20 GB of SSD storage, are only $5/month.</p><p>If you don't already have a DigitalOcean account, <a href="https://cloud.digitalocean.com/registrations/new">sign-up for one</a> before proceeding. If you are taking INFO 344, contact your TA for a promo code that you can use to get enough credit to cover the costs related to the assignments.</p><h2 id="secgeneratingandregisteringsshkeys">Generating and Registering SSH Keys</h2><p>When you create a VM in any cloud infrastructure, you need a way to connect to it via <code>ssh</code> as the root user so that you can perform administrative tasks. SSH stands for "secure shell," and to be secure it needs to authenticate you. SSH can do that in one of two ways: you can supply the root user's password (not recommended); or you create and setup SSH keys (recommended).</p><p>SSH keys are private/public key pairs, similar to the ones used in <a href="../https/">TLS</a>. You can generate this key pair on your development machine, and add the public key to any new droplet you create. When you connect, the <code>ssh</code> command uses your private key (which remains on your development machine only) to encrypt a message, and the droplet uses your public key to verify that message. Since you should be the only person in possession of your private key, it knows that you are you, and the authentication succeeds.</p><h3 id="secgenerateakeypair">Generate a Key Pair</h3><p>To see if you already have an SSH key pair generated, use this command:</p><pre class="language-bash"><code class="language-bash"><span class="token function">ls</span> ~/.ssh</code></pre><p>If you see files named <code>id_rsa</code> and <code>id_rsa.pub</code>, you already have a key pair and you can skip to the next section.</p><p>If you get a "no such file or directory" error, you don't have a key pair generated yet, so use this command to generate one:</p><pre class="language-bash"><code class="language-bash">ssh-keygen -t rsa</code></pre><p>You will be prompted as to whether you want to add a passphrase to the private key. This is an added security measure you may want to use, but beware that you'll have to type this passphrase every time you use the key. Enter the passphrase, or just hit return to use no passphrase.</p><p>You'll see some output telling you where the new "identification" (private key) and public key files were saved, as well as something that looks a bit like a QR code. Now we need to register the public key with our DigitalOcean account.</p><h3 id="secregisteryourpublickey">Register your Public Key</h3><p>After signing up for an account (or signing in to an existing one), click on your Avatar in the top right corner and choose "Settings" from the drop-down menu. Then click on the "Security" link in the left-side navigation area. Or you can <a href="https://cloud.digitalocean.com/settings/security">jump to this screen directly</a>.</p><p>Under the "SSH keys" section, choose the "Add SSH Key" button. You'll see a dialog that looks like this:</p><p><img class="screenshot" src="img/ssh-key.png" alt="add ssh key dialog"></p><p>You need to copy the contents of your <strong>public key</strong> (not your private key) into the first box. By default, the public key is stored in the file <code>~/.ssh/id_rsa.pub</code>. You can open that in your favorite text editor, or you can just dump it to your terminal using this command:</p><pre class="language-bash"><code class="language-bash"><span class="token function">cat</span> ~/.ssh/id_rsa.pub</code></pre><p>Copy the contents of that file to your clipboard and paste it into the large box labeled "SSH key content." If you're on a Mac, you can copy it to the clipboard from the terminal using this command</p><pre class="language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># MacOS only</span>
<span class="token function">cat</span> ~/.ssh/id_rsa.pub <span class="token operator">|</span> pbcopy</code></pre><p>On Windows, pipe the output to the <code>clip</code> command instead:</p><pre class="language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># Windows only</span>
<span class="token function">cat</span> ~/.ssh/id_rsa.pub <span class="token operator">|</span> clip</code></pre><p>On Linux you can install and pipe the output to the <code>xclip</code> command:</p><pre class="language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># Linux only</span>
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> -y xclip
<span class="token function">cat</span> ~/.ssh/id_rsa.pub <span class="token operator">|</span> xclip -selection c</code></pre><p>After you paste in the contents of the file, enter a name in the second box that describes the computer you are currently using (e.g., "Laptop" or "Home PC"). Since the private key will remain on this computer only, you should use something that identifies this particular computer.</p><p>You can add multiple SSH keys to your account, one for each computer you use. When you create a droplet, you can add all of the registered public keys to the new droplet, so that you can connect to it from any of your computers.</p><h2 id="seccreatingadroplet">Creating a Droplet</h2><p>Return to <a href="https://cloud.digitalocean.com/droplets">your Droplets list</a>, which will be empty. Click on the big blue button labeled "Create Droplet":</p><p><img src="img/no-droplets.png" alt="droplet list showing create droplet button" class="screenshot"></p><p>DigitalOcean has several pre-built images you can use for these droplets, including all the commonly-used Linux distros. But if you want to run a <a href="../docker/">Docker container</a>, there's a special "One-Click app" that already has Docker pre-installed on an Ubuntu Long-Term Support (LTS) distro. The specific version numbers vary over time, but it will be called something like "Docker x.x.x-ce on x.x." In the screen shot below, it's highlighted in red:</p><p><img src="img/one-click-apps.png" alt="one-click apps list highlighting Docker on Ubuntu" class="screenshot"></p><p>You can of course choose any base Linux distro and install Docker yourself, but this one-click app a convenient way to get up-and-running quickly.</p><p>After selecting the image, the next section of the page lets you choose the size of your VM. It will default to selecting the $20/month VM, so make sure you select the cheapest one instead for this tutorial.</p><p><img src="img/sizes.png" alt="list of sizes with cheapest option selected" class="screenshot"></p><p>You don't need any additional block storage, so you can skip the next section. The following section lets you choose which data center you want your VM to run in. You should choose a data center that is geographically close to your target users and/or yourself. Although the Web often feels instantaneous, geography still matters: a few hundred milliseconds of extra latency can become noticeable if your application makes a lot of requests.</p><p>You can also skip the Additional Options section for now. This allows you to add various options like IPv6 support, automated backups, monitoring, and private networking.</p><p>The following section allows you to select the SSH Key you registered in the previous section. Choose the SSH key(s) you registered, or you can register a new one if you skipped that previous section. Adding SSH keys to your droplet is a very good idea: your new droplet will be accessible only to you, as only you have the associated private key. If you don't add an SSH key, DigitalOcean will generate a random root user password and send it to you via email. Because email is not a terribly secure medium, it's best to use SSH keys instead.</p><p>In the final section you can adjust the number of droplets you are creating (leave at 1 for now) and override the host name that DigitalOcean generated for you (you can leave it as is for now). Click the big "Create" button to create your droplet.</p><h2 id="secconnectingtoyourdroplet">Connecting to Your Droplet</h2><p>You should see your new droplet in your droplets list, and once it says that the droplet is ready, copy the droplet's IP address to your clipboard. Then in a terminal window use this command to connect to it, replacing <code>ip-address</code> with your droplet's IP address:</p><pre class="language-bash"><code class="language-bash"><span class="token function">ssh</span> root@ip-address</code></pre><p>You may see a message that the host is not yet in your known hosts list, and you can enter <code>yes</code> to add it to that list. You should then see a new prompt, which is a new bash shell running on your new droplet. You can now type commands as if you were directly connected to that droplet. Everything you type will be sent to the server and executed there.</p><h2 id="secverifyingthefirewall">Verifying the Firewall</h2><p>The firewall should be enabled by default, but to verify this, enter this command:</p><pre class="language-bash"><code class="language-bash">ufw status</code></pre><p>If it reports a status of "active" you are good to go. If it reports that the firewall is not enabled, you can enable it using these commands:</p><pre class="language-bash"><code class="language-bash">ufw allow OpenSSH
ufw <span class="token function">enable</span></code></pre><p>Use <code>ufw status</code> one more time to ensure that the firewall is now active.</p><h2 id="secrunningyourdockercontainers">Running Your Docker Containers</h2><p>Docker should already be pre-installed, so to run any Docker container, simply use the <code>docker run</code> command that was discussed in the <a href="../docker/">Docker tutorial</a>. For example, to run your example web site container image you built during that tutorial, use this command</p><pre class="language-bash"><code class="language-bash">docker run -d -p 80:80 --name exsite your-dockerhub-name/examplewebsite</code></pre><p>Docker will automatically open any published ports on the firewall, so your website should now be live on the Web. You can test it by requesting the URL <code>http://ip-address</code> where <code>ip-address</code> is the IP address of your droplet.</p><h2 id="secassociatingadomainname">Associating a Domain Name</h2><p>If you want to associate a domain name you've purchased with your DigitalOcean droplet refer to their excellent <a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-a-host-name-with-digitalocean">How to Set Up a Host Name with DigitalOcean</a> tutorial. The Domain Name Server fields on your domain registrar may be somewhat difficult to find, but every registrar should let you set those.</p><h2 id="secscriptitwiththedigitaloceancli">Script It with the DigitalOcean CLI</h2><p>The DigitalOcean UI is actually just a simple web client that uses their <a href="https://developers.digitalocean.com/documentation/v2/">public API</a> to do all of the work. You can use that API from your own programs, but there's also a handy CLI you can use from bash scripts. This CLI is called <a href="https://www.digitalocean.com/community/tutorials/how-to-use-doctl-the-official-digitalocean-command-line-client">doctl</a>, and it's written in Go!</p><p>If you have Go installed, use <code>go get</code> to download and install <code>doctl</code>:</p><pre class="language-bash"><code class="language-bash">go get github.com/digitalocean/doctl/cmd/doctl</code></pre><p>To verify the installation, run <code>doctl version</code>. If you get a version number, all is OK. If you get a command not found error, something went wrong. Ensure you have Go intalled and that you <a href="../gointro/#secconfiguringgo">setup your Go Workspace</a> correctly.</p><p>The <code>doctl</code> CLI uses the public API, so you must first <a href="https://www.digitalocean.com/community/tutorials/how-to-use-the-digitalocean-api-v2#how-to-generate-a-personal-access-token">generate an access token</a> for your account, and then register that token with the tool using this command:</p><pre class="language-bash"><code class="language-bash">doctl auth init</code></pre><p>You can now use doctl to do anything you could have done through DigitalOcean's User Interface. For example, to list your current droplets, use this command:</p><pre class="language-bash"><code class="language-bash">doctl compute droplet list</code></pre><p>To list your registered SSH keys, you can use this command:</p><pre class="language-bash"><code class="language-bash">doctl compute ssh-key list</code></pre><p>To create a new droplet from the Docker on Ubuntu image, you can use a command like this:</p><pre class="language-bash"><code class="language-bash">doctl compute droplet create my-droplet-name \
--image docker-16-04 \
--region nyc1 \
--size 512mb \
--ssh-keys <span class="token punctuation">..</span>.ssh key fingerprint<span class="token punctuation">..</span>. \
--wait</code></pre><p>The best documentation for this CLI is actually in the tool itself. Use <code>doctl help</code> to list all of the available subcommands, and if you want help with any particular subcommand, add the subcommand name after <code>doctl help</code> (for example, <code>doctl help compute</code>). You can keep going to see options for final commands: for example <code>doctl help compute droplet create</code>.</p><p>Using this tool, you can easily write bash scripts to create droplets and manage domains. To run a script on a newly-created droplet, you can either use the <code>--user-data</code> flag when creating the droplet, or you can invoke the script after the droplet is running using <code>ssh</code> (replace <code>ip-address</code> with your droplet's IP address):</p><pre class="language-bash"><code class="language-bash"><span class="token function">ssh</span> -oStrictHostKeyChecking<span class="token operator">=</span>no root@<span class="token variable">$ip</span>-address <span class="token string">'bash -s'</span> <span class="token operator">&lt;</span> script-to-run-on-droplet.sh</code></pre><p>The <code>-oStrictHostKeyChecking=no</code> flag skips the part where ssh prompts you to add a new host to the list of known hosts. When scripting, you don't want programs prompting you for input.</p></div></div></main><footer class="footer"><div class="container"><div class="content"><p>Created by <a href="https://ischool.uw.edu/people/faculty/dlsinfo">Dave Stearns</a>, <a href="https://ischool.uw.edu">The Information School</a>, <a href="https://uw.edu">University of Washington</a></p><p><a href=".."><span class="icon"><i class="fa fa-home"></i> </span>back to contents</a></p></div></div></footer><script>var headings=document.querySelectorAll("h2,h3,h4,h5");headings.forEach(function(e){var a=document.createElement("a");a.textContent="#",a.href="#"+e.id,a.classList.add("bookmark-link"),e.appendChild(a)})</script><script>!function(e,t,a,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=t.createElement(a),s=t.getElementsByTagName(a)[0],o.async=1,o.src="https://www.google-analytics.com/analytics.js",s.parentNode.insertBefore(o,s)}(window,document,"script",0,"ga"),ga("create","UA-102177301-1","auto"),ga("send","pageview")</script></body></html>